<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">用户面板 - 磁力快搜</title>
	
    <!-- 核心样式 -->
    <link rel="stylesheet" href="css/core/variables.css">
    <link rel="stylesheet" href="css/core/base.css">
    
    <!-- 组件样式 -->
    <link rel="stylesheet" href="css/components/navbar.css">
    <link rel="stylesheet" href="css/components/buttons.css">
    <link rel="stylesheet" href="css/components/modal.css">
    <link rel="stylesheet" href="css/components/toast.css">
    <link rel="stylesheet" href="css/components/loading.css">
    <link rel="stylesheet" href="css/components/search.css">
    <link rel="stylesheet" href="css/components/status.css">
	<link rel="stylesheet" href="css/components/search-status.css">
    <!-- 新增：邮箱验证样式 -->
    <link rel="stylesheet" href="css/components/email-verification.css">
	
	<!-- Dashboard功能模块样式 -->
    <link rel="stylesheet" href="css/pages/dashboard/sources-management.css">
    <link rel="stylesheet" href="css/pages/dashboard/categories-management.css">
    <link rel="stylesheet" href="css/pages/dashboard/community.css">
    
    <!-- 仪表盘专用样式 -->
    <link rel="stylesheet" href="css/pages/dashboard/dashboard.css">
    
    <!-- 工具样式 -->
    <link rel="stylesheet" href="css/utils/animations.css">
    <link rel="stylesheet" href="css/utils/responsive.css">
    <link rel="stylesheet" href="css/utils/accessibility.css">
    <link rel="stylesheet" href="css/utils/print.css">

    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="./index.html">
                    <img src="images/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                    <span class="brand-text" id="brand-text">磁力快搜</span>
                </a>
            </div>
            <div class="nav-menu">
                <a href="./index.html" class="nav-link">首页</a>
                <button id="themeToggle" class="theme-btn" title="切换主题">🌙</button>
                <div id="userInfo" class="user-info">
                    <span id="username" class="username"></span>
                    <div class="dropdown">
                        <button class="dropdown-btn" title="用户菜单">▼</button>
                        <div class="dropdown-content">
                            <a href="#" class="dropdown-item active">个人中心</a>
                            <a href="#" id="logoutBtn" class="dropdown-item">退出登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="dashboard-container">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-menu">
                <div class="menu-item active" data-tab="overview">
                    <span class="menu-icon">📊</span>
                    <span class="menu-text">概览</span>
                </div>
                <div class="menu-item" data-tab="favorites">
                    <span class="menu-icon">⭐</span>
                    <span class="menu-text">我的收藏</span>
                </div>
                <div class="menu-item" data-tab="history">
                    <span class="menu-icon">🕒</span>
                    <span class="menu-text">搜索历史</span>
                </div>
                <!-- 新增：搜索源管理独立页面 -->
                <div class="menu-item" data-tab="sources">
                    <span class="menu-icon">🔗</span>
                    <span class="menu-text">搜索源管理</span>
                </div>
                <!-- 新增：分类管理独立页面 -->
                <div class="menu-item" data-tab="categories">
                    <span class="menu-icon">📂</span>
                    <span class="menu-text">分类管理</span>
                </div>
                <!-- 新增：社区标签页 -->
                <div class="menu-item" data-tab="community">
                    <span class="menu-icon">👥</span>
                    <span class="menu-text">搜索源社区</span>
                </div>
                <div class="menu-item" data-tab="settings">
                    <span class="menu-icon">⚙️</span>
                    <span class="menu-text">系统设置</span>
                </div>
                <div class="menu-item" data-tab="stats">
                    <span class="menu-icon">📈</span>
                    <span class="menu-text">统计</span>
                </div>
            </div>
        </aside>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 概览标签页 -->
            <div id="overview" class="tab-content active">
                <div class="tab-header">
                    <h1>用户概览</h1>
                    <p>欢迎回来，管理您的搜索和收藏</p>
                </div>

                <!-- 统计卡片 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">🔍</div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalSearches">0</div>
                            <div class="stat-label">总搜索次数</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⭐</div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalFavorites">0</div>
                            <div class="stat-label">收藏数量</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🔗</div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalSources">0</div>
                            <div class="stat-label">搜索源数量</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🏆</div>
                        <div class="stat-info">
                            <div class="stat-number" id="userLevel">新手</div>
                            <div class="stat-label">用户等级</div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作区域 -->
                <div class="action-buttons">
                    <button class="action-btn" data-action="search">
                        <span class="btn-icon">🔍</span>
                        <span>开始搜索</span>
                    </button>
                    <button class="action-btn" data-action="favorites">
                        <span class="btn-icon">⭐</span>
                        <span>查看收藏</span>
                    </button>
                    <button class="action-btn" data-action="sources">
                        <span class="btn-icon">🔗</span>
                        <span>管理搜索源</span>
                    </button>
                    <button class="action-btn" data-action="export">
                        <span class="btn-icon">📤</span>
                        <span>导出数据</span>
                    </button>
                </div>

                <!-- 最近活动 -->
                <div class="recent-activity">
                    <h2>最近活动</h2>
                    <div id="activityList" class="activity-list">
                        <!-- 活动列表将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>

            <!-- 收藏标签页 -->
            <div id="favorites" class="tab-content">
                <div class="tab-header">
                    <h1>我的收藏</h1>
                    <div class="header-actions">
                        <button class="btn-primary" id="syncFavoritesBtn">同步收藏</button>
                        <button class="btn-secondary" id="exportFavoritesBtn">导出收藏</button>
                    </div>
                </div>

                <!-- 收藏搜索和过滤 -->
                <div class="favorites-controls">
                    <div class="search-box">
                        <input type="text" id="favoritesSearch" placeholder="搜索收藏..." autocomplete="off">
                        <button onclick="app.searchFavorites()" title="搜索">🔍</button>
                    </div>
                    <div class="filter-options">
                        <select id="favoritesSort">
                            <option value="date-desc">按日期排序（新→旧）</option>
                            <option value="date-asc">按日期排序（旧→新）</option>
                            <option value="name-asc">按名称排序（A→Z）</option>
                            <option value="name-desc">按名称排序（Z→A）</option>
                        </select>
                    </div>
                </div>

                <!-- 收藏列表 -->
                <div id="favoritesList" class="favorites-list">
                    <!-- 收藏项将通过JavaScript动态加载 -->
                </div>
            </div>

            <!-- 搜索历史标签页 -->
            <div id="history" class="tab-content">
                <div class="tab-header">
                    <h1>搜索历史</h1>
                    <div class="header-actions">
                        <button class="btn-primary" id="syncHistoryBtn">同步历史</button>
                        <button class="btn-danger" id="clearAllHistoryBtn">清空历史</button>
                    </div>
                </div>

                <!-- 历史搜索和统计 -->
                <div class="history-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="historyCount">0</span>
                        <span class="stat-desc">搜索记录</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="uniqueKeywords">0</span>
                        <span class="stat-desc">不同关键词</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgPerDay">0</span>
                        <span class="stat-desc">日均搜索</span>
                    </div>
                </div>

                <!-- 热门关键词 -->
                <div class="popular-keywords">
                    <h3>热门搜索</h3>
                    <div id="keywordCloud" class="keyword-cloud">
                        <!-- 关键词云将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 历史记录列表 -->
                <div class="history-controls">
                    <input type="text" id="historySearch" placeholder="搜索历史记录..." autocomplete="off">
                    <select id="historyTimeFilter">
                        <option value="all">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>

                <div id="historyList" class="history-list">
                    <!-- 历史记录将通过JavaScript动态加载 -->
                </div>
            </div>

            <!-- 搜索源管理标签页 -->
            <div id="sources" class="tab-content">
                <div class="tab-header">
                    <h1>搜索源管理</h1>
                    <p>管理您的搜索源配置，启用或禁用特定搜索源</p>
                    <div class="header-actions">
                        <button class="btn-primary" id="addCustomSourceBtn">
                            <span>➕</span>
                            <span>添加自定义搜索源</span>
                        </button>
                        <button class="btn-secondary" onclick="app.exportSources()">导出搜索源</button>
                    </div>
                </div>

                <!-- 搜索源控制面板 -->
                <div class="sources-controls">
                    <div class="control-group">
                        <label>过滤条件：</label>
                        <select id="sourcesFilter">
                            <option value="all">全部搜索源</option>
                            <option value="enabled">已启用</option>
                            <option value="disabled">已禁用</option>
                            <option value="builtin">内置搜索源</option>
                            <option value="custom">自定义搜索源</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>按分类：</label>
                        <select id="categoryFilter">
                            <option value="all">全部分类</option>
                            <!-- 分类选项将动态加载 -->
                        </select>
                    </div>
                    <div class="control-group">
                        <label>排序方式：</label>
                        <select id="sourcesSort">
                            <option value="priority">按优先级</option>
                            <option value="name">按名称</option>
                            <option value="category">按分类</option>
                            <option value="status">按状态</option>
                        </select>
                    </div>
                </div>

                <!-- 搜索源管理批量操作 -->
                <div class="bulk-actions">
                    <button class="btn-secondary" id="enableAllSourcesBtn">全部启用</button>
                    <button class="btn-secondary" id="disableAllSourcesBtn">全部禁用</button>
                    <button class="btn-warning" id="resetToDefaultsBtn">重置为默认</button>
                </div>

                <!-- 搜索源列表 -->
                <div id="sourcesList" class="sources-list">
                    <div class="loading-sources">正在加载搜索源...</div>
                </div>

                <!-- 搜索源统计 -->
                <div class="sources-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="totalSourcesCount">0</span>
                            <span class="stat-desc">总搜索源数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="enabledSourcesCount">0</span>
                            <span class="stat-desc">已启用</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="customSourcesCount">0</span>
                            <span class="stat-desc">自定义搜索源</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="categoriesCount">0</span>
                            <span class="stat-desc">分类数量</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分类管理标签页 -->
            <div id="categories" class="tab-content">
                <div class="tab-header">
                    <h1>分类管理</h1>
                    <p>管理搜索源的分类，创建和编辑自定义分类</p>
                    <div class="header-actions">
                        <button class="btn-primary" id="addCustomCategoryBtn">
                            <span>➕</span>
                            <span>添加自定义分类</span>
                        </button>
                        <button class="btn-secondary" onclick="app.exportCategories()">导出分类</button>
                    </div>
                </div>

                <!-- 分类统计 -->
                <div class="categories-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="totalCategoriesCount">0</span>
                            <span class="stat-desc">总分类数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="builtinCategoriesCount">0</span>
                            <span class="stat-desc">内置分类</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="customCategoriesCount">0</span>
                            <span class="stat-desc">自定义分类</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="usedCategoriesCount">0</span>
                            <span class="stat-desc">使用中分类</span>
                        </div>
                    </div>
                </div>

                <!-- 内置分类列表 -->
                <div class="categories-section">
                    <h3>📚 内置分类</h3>
                    <p class="section-desc">系统预定义的搜索源分类，不可删除</p>
                    <div id="builtinCategoriesList" class="categories-list">
                        <!-- 内置分类将动态加载 -->
                    </div>
                </div>

                <!-- 自定义分类列表 -->
                <div class="categories-section">
                    <h3>🎨 自定义分类</h3>
                    <p class="section-desc">您创建的个性化分类，可以编辑和删除</p>
                    <div id="customCategoriesList" class="categories-list">
                        <!-- 自定义分类将动态加载 -->
                    </div>
                </div>
            </div>

            <!-- 搜索源社区标签页 -->
            <div id="community" class="tab-content">
                <div class="tab-header">
                    <h1>搜索源社区</h1>
                    <p>发现和分享优质搜索源，让搜索体验更丰富</p>
                    <div class="header-actions">
                        <button class="btn-primary" id="shareSourceBtn">
                            <span>📤</span>
                            <span>分享搜索源</span>
                        </button>
                        <button class="btn-secondary" id="mySharesBtn">
                            <span>👤</span>
                            <span>我的分享</span>
                        </button>
                        <button class="btn-secondary" id="refreshCommunityBtn" onclick="window.app.getManager('community').refreshCommunityData()">
                            <span>🔄</span>
                            <span>刷新</span>
                        </button>
                    </div>
                </div>

<!-- 社区统计面板 - 修复浏览量显示 -->
<div class="community-stats">
  <div class="stats-grid">
    <div class="stat-item">
      <span class="stat-icon">🌟</span>
      <div class="stat-info">
        <span class="stat-value" id="userSharedCount">0</span>
        <span class="stat-desc">我的分享</span>
      </div>
    </div>
    <div class="stat-item">
      <span class="stat-icon">🔥</span>
      <div class="stat-info">
        <span class="stat-value" id="userDownloadsCount">0</span>
        <span class="stat-desc">已下载</span>
      </div>
    </div>
    <div class="stat-item">
      <span class="stat-icon">👍</span>
      <div class="stat-info">
        <span class="stat-value" id="userLikesCount">0</span>
        <span class="stat-desc">获得点赞</span>
      </div>
    </div>
    <!-- 新增浏览量统计栏目 -->
    <div class="stat-item">
      <span class="stat-icon">👀</span>
      <div class="stat-info">
        <span class="stat-value" id="userViewsCount">0</span>
        <span class="stat-desc">总浏览量</span>
      </div>
    </div>
    <div class="stat-item">
      <span class="stat-icon">⭐</span>
      <div class="stat-info">
        <span class="stat-value" id="userReputationScore">0</span>
        <span class="stat-desc">社区声誉</span>
      </div>
    </div>
  </div>
</div>

<!-- 标签管理区域 -->
<div class="tag-management-section">
  <div class="tag-management-header">
    <h3>🏷️ 标签管理</h3>
    <div class="tag-management-actions">
      <!-- 新增管理标签按钮 -->
      <button class="tag-manage-btn" id="tagManageBtn">
        <span>⚙️</span>
        <span>管理标签</span>
      </button>
      <button class="tag-create-btn" id="tagCreateBtn">
        <span>✨</span>
        <span>创建标签</span>
      </button>
    </div>
  </div>
  <div class="popular-tags-list" id="popularTagsList">
    <div class="loading-tags">正在加载热门标签...</div>
  </div>
</div>

<!-- 搜索和过滤控制 -->
<div class="community-controls">
  <div class="search-section">
    <div class="search-box">
      <input type="text" id="communitySearch" placeholder="搜索社区搜索源..." autocomplete="off" aria-label="搜索社区搜索源">
      <button class="search-btn" id="communitySearchBtn" title="搜索">
        <span>🔍</span>
        <span>搜索</span>
      </button>
    </div>
    <div class="filter-toggle">
      <label class="toggle-label">
        <input type="checkbox" id="featuredOnly" aria-describedby="featured-help">
        <span>仅显示推荐</span>
      </label>
      <small id="featured-help" style="display: none;">只显示经过验证的优质搜索源</small>
    </div>
  </div>
  
  <div class="filter-section">
    <div class="filter-group">
      <label for="communityCategory">分类筛选：</label>
      <select id="communityCategory" aria-label="按分类筛选">
        <option value="all">全部分类</option>
        <!-- 分类选项将动态加载 -->
      </select>
    </div>
    <div class="filter-group">
      <label for="communitySort">排序方式：</label>
      <select id="communitySort" aria-label="排序方式">
        <option value="created_at-desc">最新发布</option>
        <option value="rating_score-desc">评分最高</option>
        <option value="download_count-desc">下载最多</option>
        <option value="like_count-desc">点赞最多</option>
        <option value="view_count-desc">浏览最多</option> <!-- 新增按浏览量排序 -->
      </select>
    </div>
    <div class="filter-group">
      <label for="communityLimit">每页显示：</label>
      <select id="communityLimit" aria-label="每页显示数量" onchange="window.app.getManager('community').currentLimit = parseInt(this.value); window.app.getManager('community').loadCommunitySourcesList();">
        <option value="10">10个</option>
        <option value="20" selected>20个</option>
        <option value="50">50个</option>
      </select>
    </div>
  </div>
</div>

<!-- 快速操作面板 -->
<div class="quick-actions" style="margin-bottom: 1.5rem;">
  <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
    <button class="btn-secondary btn-sm" onclick="window.app.getManager('community').searchCommunity('JAV')" title="搜索JAV相关源">
      <span>🎬</span>
      <span>JAV</span>
    </button>
    <button class="btn-secondary btn-sm" onclick="window.app.getManager('community').searchCommunity('电影')" title="搜索电影相关源">
      <span>🎭</span>
      <span>电影</span>
    </button>
    <button class="btn-secondary btn-sm" onclick="window.app.getManager('community').searchCommunity('磁力')" title="搜索磁力相关源">
      <span>🧲</span>
      <span>磁力</span>
    </button>
    <button class="btn-secondary btn-sm" onclick="window.app.getManager('community').searchCommunity('种子')" title="搜索种子相关源">
      <span>🌱</span>
      <span>种子</span>
    </button>
    <span style="color: var(--text-muted); font-size: 0.85rem;">快速搜索</span>
  </div>
</div>

<!-- 社区搜索源列表 -->
<div id="communitySourcesList" class="community-sources-container">
  <div class="loading-community">
    <div class="spinner"></div>
    <div>正在加载社区搜索源...</div>
  </div>
</div>

<!-- 错误处理和用户反馈改进 -->
<div id="communityErrorHandler" style="display: none;" class="error-handler">
  <div class="error-content">
    <span class="error-icon">⚠️</span>
    <div class="error-details">
      <h4>出现了一些问题</h4>
      <p id="errorMessage">加载数据时发生错误</p>
      <div class="error-actions">
        <button class="btn-primary" onclick="window.app.getManager('community').refreshCommunityData()">
          重新加载
        </button>
        <button class="btn-secondary" onclick="document.getElementById('communityErrorHandler').style.display = 'none'">
          忽略
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 页面底部信息 -->
<div class="community-footer" style="margin-top: 2rem; padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; border-top: 1px solid var(--border-color);">
  <p>🌟 社区由用户共同维护，分享优质搜索源让大家受益 🌟</p>
  <p>
    <a href="#" onclick="window.app.getManager('community').showShareSourceModal(); return false;" style="color: var(--accent-primary); text-decoration: none;">
      立即分享您的搜索源
    </a>
    |
    <a href="#" onclick="alert('举报请通过搜索源项目中的举报按钮'); return false;" style="color: var(--accent-primary); text-decoration: none;">
      举报不当内容
    </a>
    |
    <a href="#" onclick="alert('社区规则：\\n1. 分享的搜索源应该是合法的\\n2. 不得分享包含恶意内容的链接\\n3. 描述应该准确真实\\n4. 尊重他人的分享和评价'); return false;" style="color: var(--accent-primary); text-decoration: none;">
      社区规则
    </a>
  </p>
  <!-- 数据库状态指示器 -->
  <div class="db-status-indicator" id="dbStatusIndicator" style="margin-top: 0.5rem; font-size: 0.75rem;">
    <span id="dbStatus" style="color: var(--success-color);">✅ 数据库连接正常</span>
  </div>
</div>
            </div>

            <!-- 更新系统设置标签页 - 集成邮箱验证功能 -->
            <div id="settings" class="tab-content">
                <div class="tab-header">
                    <h1>系统设置</h1>
                    <p>配置系统基本设置和个人偏好</p>
                </div>

                <div class="settings-sections">
                    <!-- 基本设置 -->
                    <div class="settings-section">
                        <h3>基本设置</h3>
                        <div class="setting-item">
                            <label>主题模式</label>
                            <div class="setting-control">
                                <select id="themeMode">
                                    <option value="auto">跟随系统</option>
                                    <option value="light">浅色模式</option>
                                    <option value="dark">深色模式</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>搜索历史保留</label>
                            <div class="setting-control">
                                <select id="historyRetention">
                                    <option value="30">30天</option>
                                    <option value="90" selected>90天</option>
                                    <option value="365">1年</option>
                                    <option value="-1">永久保留</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>最大收藏数量</label>
                            <div class="setting-control">
                                <input type="number" id="maxFavorites" value="500" min="100" max="2000" step="100">
                                <span class="setting-desc">收藏夹最大容量限制</span>
                            </div>
                        </div>
                    </div>

                    <!-- 新增：搜索源状态检查设置 -->
                    <div class="settings-section status-check-settings">
                        <h4>🔍 搜索源状态检查</h4>
                        <p style="margin-bottom: 1.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                            启用此功能可在搜索前检查搜索源的可用性，提供更准确的搜索结果，但可能增加搜索时间。
                        </p>

                        <div class="setting-group">
                            <h5>启用状态检查</h5>
                            <div class="setting-row">
                                <label class="setting-label">启用搜索源状态检查</label>
                                <div class="setting-input">
                                    <input type="checkbox" id="enableSourceStatusCheck">
                                    <span class="setting-help">开启后会在搜索前检查每个搜索源的可用性</span>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h5>检查参数</h5>
                            <div class="setting-row">
                                <label class="setting-label">检查超时时间</label>
                                <div class="setting-input">
                                    <input type="number" id="sourceCheckTimeout" min="1000" max="30000" step="1000" value="8000">
                                    <span class="setting-help">单个搜索源状态检查的超时时间（毫秒）</span>
                                </div>
                            </div>
                            <div class="setting-row">
                                <label class="setting-label">状态缓存时间</label>
                                <div class="setting-input">
                                    <input type="number" id="sourceStatusCacheDuration" min="60000" max="3600000" step="60000" value="300000">
                                    <span class="setting-help">搜索源状态缓存有效期（毫秒），避免频繁检查</span>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h5>搜索行为</h5>
                            <div class="setting-row">
                                <label class="setting-label">跳过不可用搜索源</label>
                                <div class="setting-input">
                                    <input type="checkbox" id="skipUnavailableSources" checked>
                                    <span class="setting-help">搜索结果中只显示可用的搜索源</span>
                                </div>
                            </div>
                            <div class="setting-row">
                                <label class="setting-label">显示搜索源状态</label>
                                <div class="setting-input">
                                    <input type="checkbox" id="showSourceStatus" checked>
                                    <span class="setting-help">在搜索结果中显示搜索源的状态信息</span>
                                </div>
                            </div>
                            <div class="setting-row">
                                <label class="setting-label">重试失败的搜索源</label>
                                <div class="setting-input">
                                    <input type="checkbox" id="retryFailedSources">
                                    <span class="setting-help">当搜索源检查失败时是否自动重试</span>
                                </div>
                            </div>
                        </div>

                        <!-- 测试按钮 -->
                        <button type="button" class="test-status-check-btn" onclick="app.getManager('settings').testSourceStatusCheck()">
                            <span>⚡</span>
                            <span>测试状态检查功能</span>
                        </button>

                        <!-- 状态检查进度指示器 -->
                        <div id="statusCheckProgress" class="status-check-progress">
                            <div class="progress-spinner"></div>
                            <div class="progress-text">正在检查搜索源状态...</div>
                            <div class="progress-stats">0/0</div>
                        </div>
                    </div>

                    <!-- 隐私设置 -->
                    <div class="settings-section">
                        <h3>隐私设置</h3>
                        <div class="setting-item">
                            <label>行为统计</label>
                            <div class="setting-control">
                                <input type="checkbox" id="allowAnalytics" checked>
                                <span class="setting-desc">允许收集匿名使用统计，帮助改进产品</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>搜索建议</label>
                            <div class="setting-control">
                                <input type="checkbox" id="searchSuggestions" checked>
                                <span class="setting-desc">基于历史记录提供搜索建议</span>
                            </div>
                        </div>
                    </div>

                    <!-- 🔐 账户安全设置区域 - 移除旧密码修改模态框，使用邮箱验证 -->
                    <div class="settings-section">
                        <h3>🔐 账户安全</h3>
                        <div class="setting-item">
                            <label>当前邮箱</label>
                            <div class="setting-control">
                                <input type="email" id="currentEmailDisplay" disabled readonly>
                                <button class="btn-secondary" onclick="emailVerificationUI.showEmailChangeModal()">更改邮箱</button>
                            </div>
                            <span class="setting-desc">更改邮箱需要验证新旧邮箱地址</span>
                        </div>
                        <div class="setting-item">
                            <label>密码安全</label>
                            <div class="setting-control">
                                <button class="btn-warning" onclick="emailVerificationUI.showPasswordResetModal()">修改密码</button>
                                <span class="setting-desc">修改密码需要验证当前密码和邮箱验证码</span>
                            </div>
                        </div>
                    </div>

                    <!-- 🚨 账户操作区域 - 集成邮箱验证 -->
                    <div class="settings-section">
                        <h3>危险操作</h3>
                        <div class="dangerous-actions">
                            <button class="btn-danger" id="clearAllDataBtn">清空所有数据</button>
                            <button class="btn-danger" onclick="emailVerificationUI.showAccountDeleteModal()">删除账户</button>
                        </div>
                        <p class="danger-warning">
                            ⚠️ 这些操作将永久删除您的数据，且无法恢复。删除账户需要邮箱验证码确认。
                        </p>
                    </div>

                    <!-- 保存设置区域 -->
                    <div class="settings-actions">
                        <button class="btn-primary" id="saveSettingsBtn">保存设置</button>
                        <button class="btn-secondary" id="resetSettingsBtn">重置默认</button>
                    </div>
                </div>
            </div>

            <!-- 统计标签页 -->
            <div id="stats" class="tab-content">
                <div class="tab-header">
                    <h1>使用统计</h1>
                    <p>查看您的使用数据和趋势</p>
                </div>

                <!-- 时间范围选择 -->
                <div class="stats-controls">
                    <div class="time-range-selector">
                        <button class="time-btn active" data-range="7">近7天</button>
                        <button class="time-btn" data-range="30">近30天</button>
                        <button class="time-btn" data-range="90">近90天</button>
                        <button class="time-btn" data-range="365">近一年</button>
                    </div>
                </div>

                <!-- 统计图表 -->
                <div class="charts-container">
                    <div class="chart-section">
                        <h3>搜索活动趋势</h3>
                        <div id="searchTrendChart" class="chart-placeholder">
                            <p>搜索趋势图表区域</p>
                        </div>
                    </div>

                    <div class="chart-section">
                        <h3>热门搜索关键词</h3>
                        <div id="topKeywordsChart" class="chart-placeholder">
                            <div class="top-keywords-list" id="topKeywordsList">
                                <!-- 热门关键词列表 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 详细统计 -->
                <div class="detailed-stats">
                    <div class="stats-table">
                        <h3>详细数据</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>数值</th>
                                    <th>趋势</th>
                                </tr>
                            </thead>
                            <tbody id="detailedStatsTable">
                                <!-- 详细统计数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast通知 -->
    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

    <!-- Loading -->
    <div id="loading" class="loading" style="display:none;" aria-label="加载中">
        <div class="spinner"></div>
    </div>

    <!-- 脚本文件 - ES6模块化 -->
    <script type="module">
        // 修正导入路径
        import DashboardApp from './src/pages/dashboard/dashboard-app.js';
        // 🆕 导入邮箱验证UI组件
        import { emailVerificationUI } from './src/components/email-verification-ui.js';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM加载完成，开始初始化Dashboard');
            
            // 更新页面标题和品牌名称
            if (window.API_CONFIG) {
                const appName = window.API_CONFIG.APP_NAME || '磁力快搜';
                const pageTitle = document.getElementById('page-title');
                const brandText = document.getElementById('brand-text');
                
                if (pageTitle) pageTitle.textContent = `用户面板 - ${appName}`;
                if (brandText) brandText.textContent = appName;
            }
            
            try {
                // 创建全局app实例
                window.app = new DashboardApp();
                console.log('DashboardApp实例已创建');
                
                // 🆕 初始化邮箱验证集成
                initEmailVerificationIntegration();
                
                // 绑定所有按钮事件
                bindButtonEvents();
                
            } catch (error) {
                console.error('初始化Dashboard失败:', error);
                alert('系统初始化失败，请刷新页面重试');
            }
        });

        // 🆕 初始化邮箱验证集成
        function initEmailVerificationIntegration() {
            console.log('🔐 初始化邮箱验证集成...');
            
            // 使邮箱验证UI组件全局可用
            window.emailVerificationUI = emailVerificationUI;
            
            // 监听用户邮箱更改成功事件
            window.addEventListener('emailChanged', (event) => {
                console.log('邮箱已更改:', event.detail);
                // 更新设置页面中的当前邮箱显示
                const currentEmailDisplay = document.getElementById('currentEmailDisplay');
                if (currentEmailDisplay) {
                    currentEmailDisplay.value = event.detail.newEmail;
                }
                // 可以触发用户信息更新
                if (window.app && window.app.updateUserInfo) {
                    window.app.updateUserInfo();
                }
            });
            
            // 监听账户删除事件
            window.addEventListener('accountDeleted', () => {
                console.log('账户已删除，准备跳转到主页');
                // 清除本地数据并跳转
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 2000);
            });
            
            // 初始化时设置当前邮箱显示
            setTimeout(() => {
                const currentUser = window.app && window.app.getCurrentUser();
                if (currentUser && currentUser.email) {
                    const currentEmailDisplay = document.getElementById('currentEmailDisplay');
                    if (currentEmailDisplay) {
                        // 显示脱敏邮箱
                        currentEmailDisplay.value = maskEmail(currentUser.email);
                    }
                }
            }, 1000);
            
            console.log('✅ 邮箱验证集成完成');
        }
        
        // 邮箱脱敏显示
        function maskEmail(email) {
            if (!email) return '';
            const [localPart, domain] = email.split('@');
            if (localPart.length <= 2) {
                return `${localPart[0]}***@${domain}`;
            }
            const masked = localPart[0] + '*'.repeat(localPart.length - 2) + localPart[localPart.length - 1];
            return `${masked}@${domain}`;
        }

        // 绑定按钮事件的函数
        function bindButtonEvents() {
            console.log('开始绑定按钮事件');
            
            // 等待app初始化完成
            const waitForApp = () => {
                if (!window.app) {
                    console.log('等待app实例创建...');
                    setTimeout(waitForApp, 100);
                    return;
                }
                
                if (!window.app.isReady()) {
                    console.log('等待app初始化完成...');
                    setTimeout(waitForApp, 100);
                    return;
                }
                
                console.log('app已就绪，开始绑定事件');
                
                // 绑定设置相关按钮
                const settingsButtons = {
                    'saveSettingsBtn': () => window.app.saveSettings(),
                    'resetSettingsBtn': () => window.app.resetSettings(),
                    'clearAllDataBtn': () => window.app.clearAllData(),
                    
                    // 收藏相关
                    'syncFavoritesBtn': () => window.app.syncFavorites(),
                    'exportFavoritesBtn': () => window.app.exportFavorites(),
                    
                    // 历史相关
                    'syncHistoryBtn': () => window.app.syncHistory(),
                    'clearAllHistoryBtn': () => window.app.clearAllHistory(),
                    
                    // 搜索源相关
                    'enableAllSourcesBtn': () => window.app.enableAllSources(),
                    'disableAllSourcesBtn': () => window.app.disableAllSources(),
                    'resetToDefaultsBtn': () => window.app.resetToDefaults(),
                };

                // 绑定所有按钮事件
                let boundCount = 0;
                Object.entries(settingsButtons).forEach(([id, handler]) => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            try {
                                console.log(`执行按钮操作: ${id}`);
                                handler();
                            } catch (error) {
                                console.error(`按钮 ${id} 执行失败:`, error);
                                alert('操作失败，请稍后重试');
                            }
                        });
                        boundCount++;
                        console.log(`已绑定按钮: ${id}`);
                    } else {
                        console.warn(`按钮 ${id} 未找到`);
                    }
                });

                // 绑定快速操作按钮
                let actionButtonCount = 0;
                document.querySelectorAll('.action-btn[data-action]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const action = btn.dataset.action;
                        console.log(`执行快速操作: ${action}`);
                        
                        try {
                            switch (action) {
                                case 'search':
                                    window.location.href = 'index.html';
                                    break;
                                case 'favorites':
                                    window.app.switchTab('favorites');
                                    break;
                                case 'sources':
                                    window.app.switchTab('sources');
                                    break;
                                case 'export':
                                    window.app.exportData();
                                    break;
                                default:
                                    console.warn('未知操作:', action);
                            }
                        } catch (error) {
                            console.error(`快速操作 ${action} 失败:`, error);
                            alert('操作失败，请稍后重试');
                        }
                    });
                    actionButtonCount++;
                });

                // 绑定搜索收藏按钮
                const favoritesSearchBtn = document.querySelector('#favorites .search-box button');
                if (favoritesSearchBtn) {
                    favoritesSearchBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        try {
                            console.log('执行搜索收藏操作');
                            window.app.searchFavorites();
                        } catch (error) {
                            console.error('搜索收藏失败:', error);
                            alert('搜索失败，请稍后重试');
                        }
                    });
                    console.log('已绑定收藏搜索按钮');
                }

                console.log(`事件绑定完成 - 设置按钮: ${boundCount}个, 快速操作按钮: ${actionButtonCount}个`);
                
                // 验证社区管理器是否存在
                const communityManager = window.app.getManager('community');
                if (communityManager) {
                    console.log('社区管理器已就绪');
                } else {
                    console.error('社区管理器未找到');
                }
                
                console.log('所有按钮事件绑定完成');
            };
            
            // 开始等待
            waitForApp();
        }

        // 全局错误处理
        window.addEventListener('error', (event) => {
            console.error('全局错误:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('未处理的Promise拒绝:', event.reason);
        });
        
        console.log('脚本加载完成');
    </script>
</body>
</html>