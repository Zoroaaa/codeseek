// src/components/search/SearchSuggestionManager.js - ÊêúÁ¥¢Âª∫ËÆÆÁÆ°ÁêÜÂ≠êÁªÑ‰ª∂
import { escapeHtml } from '../../utils/format.js';
import { debounce } from '../../utils/helpers.js';
import searchService from '../../services/search.js';

export class SearchSuggestionManager {
  constructor() {
    this.searchHistory = [];
    this.currentSuggestions = [];
    this.isVisible = false;
    this.selectedIndex = -1;
  }

  /**
   * ÂàùÂßãÂåñÂª∫ËÆÆÁÆ°ÁêÜÂô®
   */
  async init() {
    try {
      this.bindSuggestionEvents();
      console.log('ÊêúÁ¥¢Âª∫ËÆÆÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàê');
    } catch (error) {
      console.error('ÊêúÁ¥¢Âª∫ËÆÆÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
    }
  }

  /**
   * ËÆæÁΩÆÊêúÁ¥¢ÂéÜÂè≤
   */
  setSearchHistory(history) {
    this.searchHistory = history || [];
  }

  /**
   * Â§ÑÁêÜÊêúÁ¥¢ËæìÂÖ•
   */
  handleSearchInput(value) {
    if (value.length > 0) {
      this.showSearchSuggestions(value);
    } else {
      this.hideSearchSuggestions();
    }
  }

  /**
   * ÊòæÁ§∫ÊêúÁ¥¢Âª∫ËÆÆ
   */
  showSearchSuggestions(query) {
    if (!query || typeof query !== 'string') {
      this.hideSearchSuggestions();
      return;
    }
    
    const suggestions = this.getSearchSuggestions(query);
    if (suggestions.length > 0) {
      this.renderSearchSuggestions(suggestions);
      this.isVisible = true;
      this.selectedIndex = -1;
    } else {
      this.hideSearchSuggestions();
    }
  }

  /**
   * Ëé∑ÂèñÊêúÁ¥¢Âª∫ËÆÆ
   */
  getSearchSuggestions(query) {
    if (!query || typeof query !== 'string') return [];
    
    // ‰ΩøÁî®ÊêúÁ¥¢ÊúçÂä°Ëé∑ÂèñÂª∫ËÆÆ
    const serviceSuggestions = searchService.getSearchSuggestions(query, this.searchHistory);
    
    // ‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Ëé∑ÂèñÂåπÈÖçÁöÑÂª∫ËÆÆ
    const queryLower = query.toLowerCase();
    const historySuggestions = this.searchHistory
      .filter(item => item.keyword.toLowerCase().includes(queryLower))
      .slice(0, 5)
      .map(item => ({
        type: 'history',
        keyword: item.keyword,
        query: item.keyword,
        count: item.count || 1,
        timestamp: item.timestamp
      }));

    // ÂêàÂπ∂Âπ∂ÂéªÈáçÂª∫ËÆÆ
    const allSuggestions = [...serviceSuggestions, ...historySuggestions];
    const uniqueSuggestions = allSuggestions.filter((suggestion, index, self) => 
      index === self.findIndex(s => s.keyword === suggestion.keyword)
    );

    // ÊåâÁõ∏ÂÖ≥ÊÄßÂíå‰ΩøÁî®È¢ëÁéáÊéíÂ∫è
    return uniqueSuggestions
      .sort((a, b) => {
        // ‰ºòÂÖàÊòæÁ§∫ÂÆåÂÖ®ÂåπÈÖçÁöÑ
        const aExactMatch = a.keyword.toLowerCase() === queryLower;
        const bExactMatch = b.keyword.toLowerCase() === queryLower;
        if (aExactMatch && !bExactMatch) return -1;
        if (!aExactMatch && bExactMatch) return 1;

        // ÂÖ∂Ê¨°Êåâ‰ΩøÁî®È¢ëÁéáÊéíÂ∫è
        const aCount = a.count || 0;
        const bCount = b.count || 0;
        if (aCount !== bCount) return bCount - aCount;

        // ÊúÄÂêéÊåâÊó∂Èó¥ÊéíÂ∫è
        const aTime = a.timestamp || 0;
        const bTime = b.timestamp || 0;
        return bTime - aTime;
      })
      .slice(0, 8); // ÊúÄÂ§öÊòæÁ§∫8‰∏™Âª∫ËÆÆ
  }

  /**
   * Ê∏≤ÊüìÊêúÁ¥¢Âª∫ËÆÆ
   */
  renderSearchSuggestions(suggestions) {
    let suggestionsContainer = document.getElementById('searchSuggestions');
    
    if (!suggestionsContainer) {
      suggestionsContainer = document.createElement('div');
      suggestionsContainer.id = 'searchSuggestions';
      suggestionsContainer.className = 'search-suggestions';
      
      const searchInput = document.getElementById('searchInput');
      if (searchInput && searchInput.parentNode) {
        searchInput.parentNode.appendChild(suggestionsContainer);
      }
    }
    
    if (suggestions.length === 0) {
      suggestionsContainer.style.display = 'none';
      this.isVisible = false;
      return;
    }
    
    this.currentSuggestions = suggestions;
    
    suggestionsContainer.innerHTML = suggestions.map((item, index) => {
      const displayText = item.keyword || item.query;
      const suggestionIcon = this.getSuggestionIcon(item.type);
      const frequencyInfo = item.count > 1 ? `<small class="suggestion-count">${item.count}Ê¨°</small>` : '';
      
      return `
        <div class="suggestion-item ${index === this.selectedIndex ? 'selected' : ''}" 
             data-index="${index}" 
             data-keyword="${escapeHtml(displayText)}">
          <span class="suggestion-icon">${suggestionIcon}</span>
          <span class="suggestion-text">${escapeHtml(displayText)}</span>
          ${frequencyInfo}
        </div>
      `;
    }).join('');
    
    suggestionsContainer.style.display = 'block';
    this.isVisible = true;
  }

  /**
   * Ëé∑ÂèñÂª∫ËÆÆÂõæÊ†á
   */
  getSuggestionIcon(type) {
    const icons = {
      'history': 'üïê',
      'popular': 'üî•',
      'recent': '‚≠ê',
      'trending': 'üìà',
      'suggestion': 'üí°'
    };
    return icons[type] || 'üîç';
  }

  /**
   * ÈöêËóèÊêúÁ¥¢Âª∫ËÆÆ
   */
  hideSearchSuggestions() {
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (suggestionsContainer) {
      suggestionsContainer.style.display = 'none';
    }
    this.isVisible = false;
    this.selectedIndex = -1;
    this.currentSuggestions = [];
  }

  /**
   * Â§ÑÁêÜÈîÆÁõòÂØºËà™
   */
  handleKeyNavigation(event) {
    if (!this.isVisible || this.currentSuggestions.length === 0) return false;

    switch (event.key) {
      case 'ArrowDown':
        event.preventDefault();
        this.selectedIndex = Math.min(this.selectedIndex + 1, this.currentSuggestions.length - 1);
        this.updateSelection();
        return true;

      case 'ArrowUp':
        event.preventDefault();
        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
        this.updateSelection();
        return true;

      case 'Enter':
        if (this.selectedIndex >= 0 && this.selectedIndex < this.currentSuggestions.length) {
          event.preventDefault();
          const selectedSuggestion = this.currentSuggestions[this.selectedIndex];
          this.selectSuggestion(selectedSuggestion.keyword);
          return true;
        }
        break;

      case 'Escape':
        this.hideSearchSuggestions();
        return true;

      case 'Tab':
        // TabÈîÆËá™Âä®ÂÆåÊàêÁ¨¨‰∏Ä‰∏™Âª∫ËÆÆ
        if (this.currentSuggestions.length > 0) {
          event.preventDefault();
          const firstSuggestion = this.currentSuggestions[0];
          this.selectSuggestion(firstSuggestion.keyword);
          return true;
        }
        break;
    }

    return false;
  }

  /**
   * Êõ¥Êñ∞ÈÄâÊã©Áä∂ÊÄÅ
   */
  updateSelection() {
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (!suggestionsContainer) return;

    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
    items.forEach((item, index) => {
      item.classList.toggle('selected', index === this.selectedIndex);
    });

    // ÊªöÂä®Âà∞ÈÄâ‰∏≠È°π
    if (this.selectedIndex >= 0) {
      const selectedItem = items[this.selectedIndex];
      if (selectedItem) {
        selectedItem.scrollIntoView({ block: 'nearest' });
      }
    }
  }

  /**
   * ÈÄâÊã©Âª∫ËÆÆ
   */
  selectSuggestion(keyword) {
    // Ëß¶ÂèëÂª∫ËÆÆÈÄâÊã©‰∫ã‰ª∂
    document.dispatchEvent(new CustomEvent('suggestionSelected', {
      detail: { keyword }
    }));
    
    // ÈöêËóèÂª∫ËÆÆÂàóË°®
    this.hideSearchSuggestions();
  }

  /**
   * Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÂª∫ËÆÆ
   */
  getCurrentSelection() {
    if (this.selectedIndex >= 0 && this.selectedIndex < this.currentSuggestions.length) {
      return this.currentSuggestions[this.selectedIndex];
    }
    return null;
  }

  /**
   * ÁªëÂÆöÂª∫ËÆÆ‰∫ã‰ª∂
   */
  bindSuggestionEvents() {
    // ÁªëÂÆöÊêúÁ¥¢ËæìÂÖ•‰∫ã‰ª∂
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      // ËæìÂÖ•‰∫ã‰ª∂ - ‰ΩøÁî®Èò≤Êäñ
      searchInput.addEventListener('input', debounce((e) => {
        this.handleSearchInput(e.target.value);
      }, 300));

      // ÁÑ¶ÁÇπ‰∫ã‰ª∂
      searchInput.addEventListener('focus', () => {
        const value = searchInput.value.trim();
        if (value) {
          this.showSearchSuggestions(value);
        }
      });

      // Â§±ÁÑ¶‰∫ã‰ª∂ - Âª∂ËøüÈöêËóèÔºåËÆ©ÁÇπÂáª‰∫ã‰ª∂ÊúâÊó∂Èó¥Â§ÑÁêÜ
      searchInput.addEventListener('blur', () => {
        setTimeout(() => this.hideSearchSuggestions(), 200);
      });

      // ÈîÆÁõò‰∫ã‰ª∂
      searchInput.addEventListener('keydown', (e) => {
        this.handleKeyNavigation(e);
      });
    }

    // ÁªëÂÆöÂª∫ËÆÆÁÇπÂáª‰∫ã‰ª∂
    document.addEventListener('click', (e) => {
      const suggestionItem = e.target.closest('.suggestion-item');
      if (suggestionItem) {
        const keyword = suggestionItem.dataset.keyword;
        const index = parseInt(suggestionItem.dataset.index);
        
        // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        this.selectedIndex = index;
        this.updateSelection();
        
        // ÈÄâÊã©Âª∫ËÆÆ
        this.selectSuggestion(keyword);
      }
    });

    // ÁªëÂÆöÈº†Ê†áÊÇ¨ÂÅú‰∫ã‰ª∂
    document.addEventListener('mouseover', (e) => {
      const suggestionItem = e.target.closest('.suggestion-item');
      if (suggestionItem && this.isVisible) {
        const index = parseInt(suggestionItem.dataset.index);
        this.selectedIndex = index;
        this.updateSelection();
      }
    });

    // ÁõëÂê¨ÂéÜÂè≤ÂèòÊõ¥‰∫ã‰ª∂
    document.addEventListener('historyUpdated', (e) => {
      this.setSearchHistory(e.detail.history);
    });
  }

  /**
   * Ê∑ªÂä†Ëá™ÂÆö‰πâÂª∫ËÆÆ
   */
  addCustomSuggestion(suggestion) {
    if (!suggestion || !suggestion.keyword) return;

    // Ê∑ªÂä†Âà∞ÂΩìÂâçÂª∫ËÆÆÂàóË°®
    const exists = this.currentSuggestions.find(s => s.keyword === suggestion.keyword);
    if (!exists) {
      this.currentSuggestions.unshift({
        type: 'custom',
        ...suggestion
      });
      
      // ÈáçÊñ∞Ê∏≤Êüì
      if (this.isVisible) {
        this.renderSearchSuggestions(this.currentSuggestions);
      }
    }
  }

  /**
   * ÁßªÈô§Âª∫ËÆÆ
   */
  removeSuggestion(keyword) {
    this.currentSuggestions = this.currentSuggestions.filter(s => s.keyword !== keyword);
    
    if (this.isVisible) {
      this.renderSearchSuggestions(this.currentSuggestions);
    }
  }

  /**
   * Ê∏ÖÁ©∫ÊâÄÊúâÂª∫ËÆÆ
   */
  clearSuggestions() {
    this.currentSuggestions = [];
    this.hideSearchSuggestions();
  }

  /**
   * ËÆæÁΩÆÂª∫ËÆÆËøáÊª§Âô®
   */
  setSuggestionFilter(filterFn) {
    this.customFilter = filterFn;
  }

  /**
   * Ëé∑ÂèñÂª∫ËÆÆÁªüËÆ°
   */
  getSuggestionStats() {
    return {
      currentCount: this.currentSuggestions.length,
      isVisible: this.isVisible,
      selectedIndex: this.selectedIndex,
      historyCount: this.searchHistory.length,
      suggestionTypes: this.currentSuggestions.reduce((acc, s) => {
        acc[s.type] = (acc[s.type] || 0) + 1;
        return acc;
      }, {})
    };
  }

  /**
   * ÂØºÂá∫Âª∫ËÆÆÈÖçÁΩÆ
   */
  exportSuggestionConfig() {
    return {
      searchHistory: this.searchHistory.slice(0, 20), // Âè™ÂØºÂá∫ÊúÄËøë20Êù°
      recentSuggestions: this.currentSuggestions,
      settings: {
        maxSuggestions: 8,
        enableKeyboardNav: true,
        enableMouseHover: true,
        debounceDelay: 300
      },
      exportTime: new Date().toISOString()
    };
  }

  /**
   * È¢ÑÂä†ËΩΩÁÉ≠Èó®Âª∫ËÆÆ
   */
  async preloadPopularSuggestions() {
    try {
      // ËøôÈáåÂèØ‰ª•‰ªéAPIËé∑ÂèñÁÉ≠Èó®ÊêúÁ¥¢ËØç
      const popularKeywords = [
        'ÊúÄÊñ∞', 'È´òÊ∏Ö', 'ÂÆåÊï¥Áâà', 'ÂÖçË¥π', 'Âú®Á∫ø'
      ];

      const popularSuggestions = popularKeywords.map(keyword => ({
        type: 'popular',
        keyword,
        query: keyword,
        count: Math.floor(Math.random() * 100) + 50 // Ê®°Êãü‰ΩøÁî®Ê¨°Êï∞
      }));

      // ÂèØ‰ª•Â∞ÜËøô‰∫õÂª∫ËÆÆÁºìÂ≠òËµ∑Êù•ÔºåÂú®Áî®Êà∑ËæìÂÖ•Êó∂‰ºòÂÖàÊòæÁ§∫
      this.popularSuggestions = popularSuggestions;
      
    } catch (error) {
      console.warn('È¢ÑÂä†ËΩΩÁÉ≠Èó®Âª∫ËÆÆÂ§±Ë¥•:', error);
    }
  }

  /**
   * Ëé∑ÂèñÁõ∏ÂÖ≥Âª∫ËÆÆ
   */
  getRelatedSuggestions(keyword) {
    if (!keyword) return [];

    // Âü∫‰∫éÂÖ≥ÈîÆËØçÁîüÊàêÁõ∏ÂÖ≥Âª∫ËÆÆ
    const relatedTerms = [];
    
    // Ê∑ªÂä†Â∏∏ËßÅÁöÑ‰øÆÈ•∞ËØç
    const modifiers = ['È´òÊ∏Ö', 'ÂÆåÊï¥Áâà', 'ÊúÄÊñ∞', 'ÂÖçË¥π', 'Âú®Á∫ø'];
    modifiers.forEach(modifier => {
      if (!keyword.includes(modifier)) {
        relatedTerms.push(`${keyword} ${modifier}`);
      }
    });

    // ‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Êü•ÊâæÁõ∏ÂÖ≥È°π
    const historyRelated = this.searchHistory
      .filter(item => {
        const itemWords = item.keyword.toLowerCase().split(/\s+/);
        const keywordWords = keyword.toLowerCase().split(/\s+/);
        return itemWords.some(word => keywordWords.includes(word));
      })
      .slice(0, 3);

    return [...relatedTerms.slice(0, 3), ...historyRelated.map(h => h.keyword)]
      .filter(term => term !== keyword)
      .slice(0, 5);
  }

  /**
   * Ê∏ÖÁêÜËµÑÊ∫ê
   */
  cleanup() {
    this.hideSearchSuggestions();
    this.currentSuggestions = [];
    this.searchHistory = [];
    this.selectedIndex = -1;
    this.isVisible = false;
    
    // ÁßªÈô§Âª∫ËÆÆÂÆπÂô®
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (suggestionsContainer) {
      suggestionsContainer.remove();
    }
    
    console.log('ÊêúÁ¥¢Âª∫ËÆÆÁÆ°ÁêÜÂô®ËµÑÊ∫êÂ∑≤Ê∏ÖÁêÜ');
  }
}

export default SearchSuggestionManager;