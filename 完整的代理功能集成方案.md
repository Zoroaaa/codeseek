åŸºäºæ‚¨çš„é¡¹ç›®æ¶æ„ï¼Œæˆ‘å°†æä¾›ä¸€ä¸ªå®Œæ•´çš„ä»£ç†åŠŸèƒ½é›†æˆæ–¹æ¡ˆã€‚æ‚¨çš„é¡¹ç›®ç»“æ„æ¸…æ™°ï¼Œä»£ç†åŠŸèƒ½å¯ä»¥ä¼˜é›…åœ°èå…¥ç°æœ‰æ¶æ„ã€‚

## ğŸ“‹ é›†æˆæ–¹æ¡ˆæ¦‚è¿°

### 1ï¸âƒ£ **éƒ¨ç½²ä»£ç†Worker**

é¦–å…ˆï¼Œå°†æ‚¨çš„ `worker.js` éƒ¨ç½²ä¸ºç‹¬ç«‹çš„ Cloudflare Workerï¼š

```javascript
// ä¿®æ”¹ worker.jsï¼Œæ·»åŠ CORSæ”¯æŒå’Œæ›´å¥½çš„é”™è¯¯å¤„ç†
export default {
  async fetch(request, env, ctx) {
    try {
      // æ·»åŠ CORSå¤´æ”¯æŒæ‚¨çš„ä¸»ç«™è®¿é—®
      const corsHeaders = {
        'Access-Control-Allow-Origin': env.ALLOWED_ORIGINS || '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type',
      };

      // å¤„ç†é¢„æ£€è¯·æ±‚
      if (request.method === 'OPTIONS') {
        return new Response(null, { headers: corsHeaders });
      }

      // ç°æœ‰çš„ä»£ç†é€»è¾‘...
      const {
        PROXY_HOSTNAME,
        PROXY_PROTOCOL = "https",
        // ... å…¶ä»–é…ç½®
      } = env;

      // æ·»åŠ å“åº”å¤´
      const response = await handleProxyRequest(request, env);
      Object.entries(corsHeaders).forEach(([key, value]) => {
        response.headers.set(key, value);
      });
      
      return response;
    } catch (error) {
      console.error('Proxy error:', error);
      return new Response('Proxy Error', { status: 500 });
    }
  }
};
```

### 2ï¸âƒ£ **ä¿®æ”¹æœç´¢ç»“æœå¤„ç†**

åœ¨ `frontend/src/services/search.js` ä¸­æ·»åŠ ä»£ç†URLåŒ…è£…åŠŸèƒ½ï¼š

```javascript
// åœ¨ SearchService ç±»ä¸­æ·»åŠ ä»£ç†é…ç½®
class SearchService {
  constructor() {
    // ... ç°æœ‰ä»£ç 
    
    // ä»£ç†é…ç½®
    this.proxyConfig = {
      enabled: false, // é€šè¿‡ç”¨æˆ·è®¾ç½®æ§åˆ¶
      baseUrl: '', // ä»£ç†æœåŠ¡å™¨URL
      needsProxy: new Set(), // éœ€è¦ä»£ç†çš„æœç´¢æºID
    };
  }

  // åˆå§‹åŒ–ä»£ç†é…ç½®
  async initProxyConfig() {
    try {
      // ä»ç”¨æˆ·è®¾ç½®æˆ–ç¯å¢ƒå˜é‡è·å–ä»£ç†é…ç½®
      const userSettings = await this.getUserSettings();
      const proxyBaseUrl = window.API_CONFIG?.PROXY_BASE_URL || 
                          'https://your-proxy.workers.dev';
      
      this.proxyConfig = {
        enabled: userSettings.enableProxy || false,
        baseUrl: proxyBaseUrl,
        // ä»æ•°æ®åº“æˆ–é…ç½®è·å–éœ€è¦ä»£ç†çš„æº
        needsProxy: new Set(userSettings.proxiedSources || [
          'javbus', 'javdb', 'javlibrary', 'btsow'
        ])
      };
    } catch (error) {
      console.error('åˆå§‹åŒ–ä»£ç†é…ç½®å¤±è´¥:', error);
    }
  }

  // åŒ…è£…URLä¸ºä»£ç†URL
  wrapWithProxy(url, sourceId) {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä»£ç†
    if (!this.proxyConfig.enabled || !this.proxyConfig.needsProxy.has(sourceId)) {
      return url;
    }

    try {
      const targetUrl = new URL(url);
      const proxyUrl = new URL(this.proxyConfig.baseUrl);
      
      // æ„å»ºä»£ç†URL
      // æ–¹æ¡ˆ1: ä½¿ç”¨è·¯å¾„å‚æ•°
      proxyUrl.pathname = `/proxy/${targetUrl.hostname}${targetUrl.pathname}`;
      proxyUrl.search = targetUrl.search;
      
      // æ–¹æ¡ˆ2: ä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼ˆå¤‡é€‰ï¼‰
      // proxyUrl.searchParams.set('target', url);
      
      return proxyUrl.toString();
    } catch (error) {
      console.error('åŒ…è£…ä»£ç†URLå¤±è´¥:', error);
      return url; // å¤±è´¥æ—¶è¿”å›åŸURL
    }
  }

  // ä¿®æ”¹æ„å»ºæœç´¢ç»“æœæ–¹æ³•
  buildResultsFromSources(sources, keyword, encodedKeyword, timestamp) {
    return sources.map(source => {
      const originalUrl = source.urlTemplate.replace('{keyword}', encodedKeyword);
      
      // åº”ç”¨ä»£ç†åŒ…è£…
      const proxyUrl = this.wrapWithProxy(originalUrl, source.id);
      
      const result = {
        id: `result_${keyword}_${source.id}_${timestamp}`,
        title: source.name,
        subtitle: source.subtitle,
        url: proxyUrl, // ä½¿ç”¨ä»£ç†URL
        originalUrl: originalUrl, // ä¿ç•™åŸå§‹URL
        source: source.id,
        keyword: keyword,
        timestamp: timestamp,
        needsProxy: this.proxyConfig.needsProxy.has(source.id)
      };
      
      // ... å…¶ä»–å­—æ®µ
      
      return result;
    });
  }
}
```

### 3ï¸âƒ£ **æ·»åŠ æ•°æ®åº“æ”¯æŒ**

åœ¨ `sqllite d1/08_search_source.sql` ä¸­æ·»åŠ ä»£ç†é…ç½®å­—æ®µï¼š

```sql
-- åœ¨ search_sources è¡¨ä¸­æ·»åŠ ä»£ç†é…ç½®
ALTER TABLE search_sources ADD COLUMN needs_proxy INTEGER DEFAULT 0;
ALTER TABLE search_sources ADD COLUMN proxy_config TEXT DEFAULT NULL;

-- åœ¨ user_search_source_configs è¡¨ä¸­æ·»åŠ ç”¨æˆ·çº§ä»£ç†é…ç½®
ALTER TABLE user_search_source_configs ADD COLUMN use_proxy INTEGER DEFAULT 0;
ALTER TABLE user_search_source_configs ADD COLUMN custom_proxy_url TEXT DEFAULT NULL;

-- æ›´æ–°éœ€è¦ä»£ç†çš„é»˜è®¤æœç´¢æº
UPDATE search_sources 
SET needs_proxy = 1 
WHERE id IN ('javbus', 'javdb', 'javlibrary', 'btsow', 'sukebei');
```

### 4ï¸âƒ£ **åç«¯APIæ”¯æŒ**

åœ¨ `src/handlers/search-sources.js` ä¸­æ·»åŠ ä»£ç†é…ç½®å¤„ç†ï¼š

```javascript
// æ·»åŠ è·å–ä»£ç†é…ç½®çš„å¤„ç†å™¨
export async function getProxyConfigHandler(request, env) {
  const user = await authenticate(request, env);
  if (!user) {
    return utils.errorResponse('è®¤è¯å¤±è´¥', 401);
  }

  try {
    // è·å–ç”¨æˆ·çš„ä»£ç†é…ç½®
    const proxyConfig = await env.DB.prepare(`
      SELECT 
        ss.id,
        ss.name,
        ss.needs_proxy,
        ss.proxy_config,
        usc.use_proxy as user_proxy_enabled,
        usc.custom_proxy_url
      FROM search_sources ss
      LEFT JOIN user_search_source_configs usc 
        ON ss.id = usc.source_id AND usc.user_id = ?
      WHERE ss.needs_proxy = 1
    `).bind(user.id).all();

    // è·å–å…¨å±€ä»£ç†è®¾ç½®
    const globalProxy = {
      enabled: env.PROXY_ENABLED === 'true',
      baseUrl: env.PROXY_BASE_URL || '',
      defaultSources: env.PROXY_DEFAULT_SOURCES?.split(',') || []
    };

    return utils.successResponse({
      global: globalProxy,
      sources: proxyConfig.results || []
    });
  } catch (error) {
    console.error('è·å–ä»£ç†é…ç½®å¤±è´¥:', error);
    return utils.errorResponse('è·å–ä»£ç†é…ç½®å¤±è´¥', 500);
  }
}

// æ›´æ–°ç”¨æˆ·ä»£ç†è®¾ç½®
export async function updateProxySettingsHandler(request, env) {
  const user = await authenticate(request, env);
  if (!user) {
    return utils.errorResponse('è®¤è¯å¤±è´¥', 401);
  }

  try {
    const { sourceId, useProxy, customProxyUrl } = await request.json();
    
    await env.DB.prepare(`
      UPDATE user_search_source_configs 
      SET use_proxy = ?, custom_proxy_url = ?, updated_at = ?
      WHERE user_id = ? AND source_id = ?
    `).bind(
      useProxy ? 1 : 0,
      customProxyUrl || null,
      Date.now(),
      user.id,
      sourceId
    ).run();

    return utils.successResponse({ message: 'ä»£ç†è®¾ç½®å·²æ›´æ–°' });
  } catch (error) {
    console.error('æ›´æ–°ä»£ç†è®¾ç½®å¤±è´¥:', error);
    return utils.errorResponse('æ›´æ–°ä»£ç†è®¾ç½®å¤±è´¥', 500);
  }
}
```

### 5ï¸âƒ£ **å‰ç«¯UIé›†æˆ**

åœ¨ `SearchResultsRenderer.js` ä¸­æ·»åŠ ä»£ç†çŠ¶æ€æ˜¾ç¤ºï¼š

```javascript
createResultHTML(result, config) {
  // ... ç°æœ‰ä»£ç 
  
  // æ·»åŠ ä»£ç†çŠ¶æ€æŒ‡ç¤º
  const proxyIndicator = result.needsProxy ? `
    <span class="proxy-indicator" title="é€šè¿‡ä»£ç†è®¿é—®">
      ğŸ” ä»£ç†
    </span>
  ` : '';
  
  // ä¿®æ”¹è®¿é—®æŒ‰é’®ï¼Œæ”¯æŒä»£ç†å’Œç›´è¿åˆ‡æ¢
  const visitButtonHTML = `
    <div class="visit-options">
      <button class="action-btn visit-btn" 
              data-action="visit" 
              data-url="${escapeHtml(result.url)}" 
              data-source="${result.source}">
        <span>è®¿é—®${result.needsProxy ? '(ä»£ç†)' : ''}</span>
      </button>
      ${result.needsProxy && result.originalUrl ? `
        <button class="action-btn direct-btn" 
                data-action="visitDirect" 
                data-url="${escapeHtml(result.originalUrl)}"
                title="ç›´æ¥è®¿é—®(ä¸ä½¿ç”¨ä»£ç†)">
          <span>ç›´è¿</span>
        </button>
      ` : ''}
    </div>
  `;
  
  // ... ç»§ç»­ç°æœ‰ä»£ç 
}
```

### 6ï¸âƒ£ **ç”¨æˆ·è®¾ç½®é¡µé¢**

åœ¨ `sources-manager.js` ä¸­æ·»åŠ ä»£ç†é…ç½®UIï¼š

```javascript
renderSourceItem(source) {
  // ... ç°æœ‰ä»£ç 
  
  // æ·»åŠ ä»£ç†é…ç½®é€‰é¡¹
  const proxyConfig = `
    <div class="source-proxy-config">
      <label>
        <input type="checkbox" 
               ${source.needsProxy ? 'checked' : ''} 
               onchange="app.getManager('sources').toggleSourceProxy('${source.id}', this.checked)">
        ä½¿ç”¨ä»£ç†è®¿é—®
      </label>
      ${source.needsProxy ? `
        <input type="text" 
               placeholder="è‡ªå®šä¹‰ä»£ç†URL(å¯é€‰)" 
               value="${source.customProxyUrl || ''}"
               onblur="app.getManager('sources').updateCustomProxy('${source.id}', this.value)">
      ` : ''}
    </div>
  `;
  
  // ... ç»§ç»­æ¸²æŸ“
}

// æ·»åŠ ä»£ç†æ§åˆ¶æ–¹æ³•
async toggleSourceProxy(sourceId, enabled) {
  try {
    await searchSourcesAPI.updateProxySettings({
      sourceId,
      useProxy: enabled
    });
    showToast(`å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ä»£ç†`, 'success');
  } catch (error) {
    console.error('æ›´æ–°ä»£ç†è®¾ç½®å¤±è´¥:', error);
    showToast('æ“ä½œå¤±è´¥', 'error');
  }
}
```

### 7ï¸âƒ£ **ç¯å¢ƒå˜é‡é…ç½®**

åœ¨ `wrangler.toml` ä¸­æ·»åŠ ä»£ç†é…ç½®ï¼š

```toml
[vars]
PROXY_ENABLED = "true"
PROXY_BASE_URL = "https://your-proxy.workers.dev"
PROXY_DEFAULT_SOURCES = "javbus,javdb,javlibrary,btsow"

# ä»£ç†Workerçš„é…ç½®
[env.proxy]
name = "magnet-search-proxy"
vars = { PROXY_HOSTNAME = "target-site.com" }
```

### 8ï¸âƒ£ **æ™ºèƒ½è·¯ç”±ç­–ç•¥**

åˆ›å»ºæ™ºèƒ½ä»£ç†è·¯ç”±æœåŠ¡ï¼š

```javascript
// src/services/proxy-router.js
export class ProxyRouter {
  constructor() {
    this.rules = new Map();
    this.cache = new Map();
  }

  // æ ¹æ®æºå’Œåœ°åŒºè‡ªåŠ¨é€‰æ‹©æ˜¯å¦ä½¿ç”¨ä»£ç†
  shouldUseProxy(sourceId, userRegion) {
    // ç¼“å­˜æ£€æŸ¥
    const cacheKey = `${sourceId}-${userRegion}`;
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey);
    }

    // è§„åˆ™åŒ¹é…
    const rules = {
      'javbus': ['CN', 'RU', 'IR'], // è¿™äº›åœ°åŒºéœ€è¦ä»£ç†
      'javdb': ['CN'],
      'sukebei': ['CN', 'KR'],
      // ... æ›´å¤šè§„åˆ™
    };

    const needsProxy = rules[sourceId]?.includes(userRegion) || false;
    this.cache.set(cacheKey, needsProxy);
    
    return needsProxy;
  }

  // é€‰æ‹©æœ€ä½³ä»£ç†æœåŠ¡å™¨
  selectBestProxy(sourceId, userRegion) {
    const proxies = {
      'US': 'https://us-proxy.workers.dev',
      'EU': 'https://eu-proxy.workers.dev',
      'ASIA': 'https://asia-proxy.workers.dev',
    };

    // æ ¹æ®ç”¨æˆ·åœ°åŒºé€‰æ‹©æœ€è¿‘çš„ä»£ç†
    if (userRegion === 'CN') return proxies.ASIA;
    if (['DE', 'FR', 'UK'].includes(userRegion)) return proxies.EU;
    return proxies.US;
  }
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **éƒ¨ç½²ä»£ç†Worker**:
```bash
cd proxy-worker
wrangler deploy
```

2. **æ›´æ–°æ•°æ®åº“ç»“æ„**:
```bash
wrangler d1 execute codeseek --file=./migrations/add-proxy-support.sql
```

3. **é…ç½®ç¯å¢ƒå˜é‡**:
```bash
wrangler secret put PROXY_BASE_URL
```

4. **æ›´æ–°å‰ç«¯é…ç½®**:
```javascript
window.API_CONFIG = {
  ...window.API_CONFIG,
  PROXY_BASE_URL: 'https://your-proxy.workers.dev',
  PROXY_ENABLED: true
};
```

è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥è®©æ‚¨çš„æœç´¢ç»“æœé€šè¿‡ä»£ç†è®¿é—®ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œçµæ´»çš„é…ç½®é€‰é¡¹ã€‚éœ€è¦æˆ‘è¯¦ç»†è¯´æ˜æŸä¸ªéƒ¨åˆ†çš„å®ç°å—ï¼Ÿ