name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main ]
    paths: ['codeseek-site/**']

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Codeseek Site to Production
    defaults:
      run:
        working-directory: ./codeseek-site
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # 强制获取完整历史，确保所有文件同步
          fetch-depth: 0
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'codeseek-site/package-lock.json'
      
      - name: Install and Update Dependencies
        run: |
          echo "安装和更新依赖..."
          # 检查当前状态
          echo "=== 安装前状态 ==="
          ls -la package*.json || echo "没有 package 文件"
          
          # 检查并备份 package-lock.json
          if [ -f package-lock.json ]; then
            echo "备份旧的 lock 文件..."
            cp package-lock.json package-lock.json.backup.$(date +%Y%m%d_%H%M%S)
            
            # 检查 Wrangler 版本是否匹配
            CURRENT_WRANGLER=$(node -e "console.log(require('./package.json').devDependencies?.wrangler || 'not-found')" 2>/dev/null || echo "not-found")
            EXPECTED_WRANGLER="4.0.0"
            
            if [ "$CURRENT_WRANGLER" != "$EXPECTED_WRANGLER" ]; then
              echo "Wrangler 版本不匹配: 当前 $CURRENT_WRANGLER, 期望 $EXPECTED_WRANGLER"
              echo "更新 package.json 中的 Wrangler 版本..."
              
              # 更新 package.json
              node << 'EOF'
              const fs = require('fs');
              const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              
              if (!packageJson.devDependencies) packageJson.devDependencies = {};
              packageJson.devDependencies.wrangler = '4.0.0';
              
              if (!packageJson.engines) packageJson.engines = {};
              packageJson.engines.node = '>=18.0.0';
              
              fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
              console.log('✅ 更新 package.json 完成');
              EOF
              
              # 删除旧的依赖
              rm package-lock.json
              if [ -d node_modules ]; then
                rm -rf node_modules
              fi
            else
              echo "Wrangler 版本匹配，检查依赖同步..."
              # 检查 package-lock.json 是否同步
              if ! npm ls --depth=0 > /dev/null 2>&1; then
                echo "package-lock.json 不同步，重新生成..."
                rm package-lock.json
                if [ -d node_modules ]; then
                  rm -rf node_modules
                fi
              fi
            fi
          fi
          
          # 全新安装
          echo "执行全新安装..."
          npm install
          
          # 验证安装
          echo "=== 安装后验证 ==="
          npx wrangler --version
          echo "Wrangler 版本验证完成"
      
      - name: Validate Configuration
        run: |
          echo "验证配置文件..."
          npx wrangler --version
          npx wrangler whoami
          
          # 检查必要文件
          echo "检查项目文件..."
          if [ -f src/worker.js ]; then
            echo "✅ worker.js 存在"
          else
            echo "❌ worker.js 不存在"
            exit 1
          fi
          
          if [ -f wrangler.toml ]; then
            echo "✅ wrangler.toml 存在"
          else
            echo "❌ wrangler.toml 不存在"
            exit 1
          fi
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./codeseek-site
          command: deploy
        env:
          # 确保使用最新的 Wrangler
          WRANGLER_VERSION: 4
      
      - name: Health Check with Retry
        run: |
          echo "部署完成，执行健康检查..."
          sleep 20
          
          # 添加重试机制
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "健康检查尝试 $attempt/$max_attempts"
            if curl -f https://codeseek-site.zadi.workers.dev/api/health; then
              echo "✅ 健康检查成功"
              exit 0
            else
              echo "❌❌ 健康检查失败，等待 10 秒后重试..."
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
          
          echo "❌❌ 所有健康检查尝试都失败"
          exit 1
