name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main ]
    paths: ['codeseek-site/**']

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Codeseek Site to Production
    defaults:
      run:
        working-directory: ./codeseek-site
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'codeseek-site/package-lock.json'
      
      - name: Install and Update Dependencies
        run: |
          echo "安装和更新依赖..."
          echo "=== 安装前状态 ==="
          ls -la package*.json || echo "没有 package 文件"
          
          # 检查 package-lock.json 是否为空或无效
          if [ -f package-lock.json ]; then
            if [ $(stat -f%z package-lock.json 2>/dev/null || stat -c%s package-lock.json) -lt 10 ]; then
              echo "package-lock.json 文件为空或太小，删除并重新生成"
              rm package-lock.json
            else
              echo "package-lock.json 文件大小正常"
            fi
          fi
          
          # 检查 Wrangler 版本是否匹配
          if [ -f package.json ]; then
            CURRENT_WRANGLER=$(node -e "try { console.log(require('./package.json').devDependencies?.wrangler || 'not-found') } catch(e) { console.log('parse-error') }" 2>/dev/null || echo "error")
            EXPECTED_WRANGLER="^4.60.0"
            
            if [ "$CURRENT_WRANGLER" != "$EXPECTED_WRANGLER" ]; then
              echo "Wrangler 版本需要更新: 当前 $CURRENT_WRANGLER, 期望 $EXPECTED_WRANGLER"
              
              # 使用更安全的方式更新 package.json
              node -e "
              const fs = require('fs');
              try {
                const packagePath = './package.json';
                const packageJson = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
                
                // 更新 devDependencies
                if (!packageJson.devDependencies) packageJson.devDependencies = {};
                packageJson.devDependencies.wrangler = '$EXPECTED_WRANGLER';
                
                // 确保 engines 配置正确
                if (!packageJson.engines) packageJson.engines = {};
                packageJson.engines.node = '>=20.0.0';
                
                fs.writeFileSync(packagePath, JSON.stringify(packageJson, null, 2));
                console.log('✅ 更新 package.json 完成');
              } catch (error) {
                console.error('❌ 更新 package.json 失败:', error.message);
                process.exit(1);
              }
              "
              
              # 清理旧的依赖文件
              if [ -f package-lock.json ]; then
                rm package-lock.json
              fi
              if [ -d node_modules ]; then
                rm -rf node_modules
              fi
            else
              echo "Wrangler 版本匹配，检查依赖同步..."
            fi
          fi
          
          # 全新安装
          echo "执行全新安装..."
          npm install --force
          
          # 验证安装
          echo "=== 安装后验证 ==="
          npx wrangler --version
          echo "Wrangler 版本验证完成"
      
      - name: Validate Configuration
        run: |
          echo "验证配置文件..."
          npx wrangler --version
          npx wrangler whoami
          
          # 检查必要文件
          echo "检查项目文件..."
          if [ -f src/worker.js ]; then
            echo "✅ worker.js 存在"
          else
            echo "❌ worker.js 不存在"
            exit 1
          fi
          
          if [ -f wrangler.toml ]; then
            echo "✅ wrangler.toml 存在"
            # 验证 TOML 语法
            npx wrangler deploy --dry-run --env=production
          else
            echo "❌ wrangler.toml 不存在"
            exit 1
          fi
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./codeseek-site
          command: deploy --env=production  # 明确指定环境
        env:
          WRANGLER_VERSION: 4
      
      - name: Health Check with Retry
        run: |
          echo "部署完成，执行健康检查..."
          sleep 20
          
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "健康检查尝试 $attempt/$max_attempts"
            if curl -f https://codeseek-site.zadi.workers.dev/api/health; then
              echo "✅ 健康检查成功"
              exit 0
            else
              echo "健康检查失败，等待 10 秒后重试..."
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
          
          echo "❌ 所有健康检查尝试都失败"
          exit 1
