name = "codeseek-backend"
main = "src/index.js"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[vars]
APP_VERSION = "2.1.0"
ALLOW_REGISTRATION = "true"
MAX_FAVORITES_PER_USER = "1000"
MAX_HISTORY_PER_USER = "1000"
MAX_TAGS_PER_USER = "50"
COMMUNITY_MAX_SHARES_PER_USER = "50"
ENABLE_ACTION_LOGGING = "true"

# ===============================================
# 邮箱验证功能配置（新增）
# ===============================================

# 基础功能开关
EMAIL_VERIFICATION_ENABLED = "true"        # 是否启用邮箱验证功能
EMAIL_VERIFICATION_REQUIRED = "false"      # 注册时是否强制邮箱验证（建议先设为false测试）

# 验证码配置
VERIFICATION_CODE_LENGTH = "6"             # 验证码长度（6位数字）
VERIFICATION_CODE_EXPIRY = "900000"        # 验证码过期时间（15分钟，单位：毫秒）
MAX_VERIFICATION_ATTEMPTS = "3"            # 单个验证码最大尝试次数

# 发送频率限制
EMAIL_RATE_LIMIT_PER_HOUR = "5"           # 每小时最大发送邮件数
EMAIL_RATE_LIMIT_PER_DAY = "20"           # 每天最大发送邮件数

# 邮件发送配置
DEFAULT_FROM_EMAIL = "noreply@codeseek.pp.ua"  # 发件人邮箱
DEFAULT_FROM_NAME = "磁力快搜"              # 发件人姓名
SITE_URL = "https://codeseek.pp.ua"        # 站点URL（用于邮件模板）

# JWT配置（现有）
JWT_EXPIRY_DAYS = "30"

[[d1_databases]]
binding = "DB"
database_name = "codeseek"
database_id = "42216a7e-3dbb-4feb-9974-2a8ee32af550"

[observability]
enabled = true

[env.production]
name = "codeseek-backend-prod"

[env.staging]
name = "magnet-search-backend-staging"

# ===============================================
# 环境变量说明（需要在 Cloudflare Workers 控制台中设置的敏感信息）
# ===============================================

# 这些变量包含敏感信息，需要在 Cloudflare Workers 控制台的环境变量中设置：

# RESEND_API_KEY = "re_xxxxxxxxxxxxxxxxxxxxxxxxx"
# 说明：Resend 邮件服务的 API 密钥
# 获取方式：
# 1. 访问 https://resend.com/ 注册账户
# 2. 在 Dashboard 中创建 API Key
# 3. 将 API Key 添加到 Cloudflare Workers 环境变量中

# JWT_SECRET = "your-super-secure-jwt-secret-key-here"
# 说明：JWT Token 加密密钥，建议使用 64 位随机字符串
# 生成方式：node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# ===============================================
# 设置环境变量的步骤说明
# ===============================================

# 1. 登录 Cloudflare Dashboard
# 2. 进入 Workers & Pages > 选择你的 Worker
# 3. 进入 Settings > Environment Variables
# 4. 添加以下变量：
#    - RESEND_API_KEY: 你的 Resend API 密钥
#    - JWT_SECRET: 你的 JWT 密钥（如果还没设置）
# 5. 保存并重新部署 Worker

# ===============================================
# Resend 域名验证说明
# ===============================================

# 要使用自定义发件人域名（如 noreply@codeseek.pp.ua），需要：
# 1. 在 Resend 控制台添加域名
# 2. 按照指示添加 DNS 记录验证域名所有权
# 3. 验证通过后才能使用该域名发送邮件
# 
# 临时测试可以使用 Resend 提供的测试域名：
# DEFAULT_FROM_EMAIL = "onboarding@resend.dev"

# ===============================================
# 部署后的验证步骤
# ===============================================

# 1. 执行数据库迁移：
#    wrangler d1 execute codeseek --file=schema-email-verification.sql
#    
# 2. 测试邮件发送：
#    curl -X POST https://your-worker.your-subdomain.workers.dev/api/auth/send-registration-code \
#      -H "Content-Type: application/json" \
#      -d '{"email":"test@example.com"}'
#
# 3. 检查系统配置：
#    curl https://your-worker.your-subdomain.workers.dev/api/config
#    查看返回的配置中是否包含邮箱验证相关配置

# ===============================================
# 可选：本地开发配置
# ===============================================

# 如果需要本地开发，创建 .dev.vars 文件（不要提交到版本控制）：
# RESEND_API_KEY=your_resend_api_key_here
# JWT_SECRET=your_jwt_secret_here
# EMAIL_VERIFICATION_ENABLED=true
# EMAIL_VERIFICATION_REQUIRED=false